<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é…¸åŒ–é‚„å…ƒãƒã‚¹ã‚¿ãƒ¼ | Oxidation Master</title>
    <!-- Prevent 404 for favicon -->
    <link rel="icon" href="data:,">
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase SDKs (Modular) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs, updateDoc, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // ==========================================
        // CONFIGURATION: ã“ã“ã‚’ã”è‡ªèº«ã®Firebaseè¨­å®šã«æ›¸ãæ›ãˆã¦ãã ã•ã„
        // ==========================================
        const firebaseConfig = {
          apiKey: "AIzaSyDiWnI_xkdwSnTL36AJm1e1OLcOugaBdWk",
          authDomain: "redox-game.firebaseapp.com",
          projectId: "redox-game",
          storageBucket: "redox-game.firebasestorage.app",
          messagingSenderId: "792171243217",
          appId: "1:792171243217:web:e361fbfcc1110585a107f0"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // Global access for React
        window.db = db;
        window.auth = auth;
        window.provider = provider;
        window.signInWithPopup = signInWithPopup;
        window.signOut = signOut;
        window.onAuthStateChanged = onAuthStateChanged; 
        window.doc = doc;
        window.setDoc = setDoc;
        window.getDoc = getDoc;
        window.updateDoc = updateDoc;
        window.collection = collection;
        window.getDocs = getDocs;
        window.serverTimestamp = serverTimestamp;
        window.query = query;
        window.where = where;

        // Signal that Firebase is ready
        window.firebaseInitialized = true;
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <style>
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #f3f4f6; }
        .chemical-formula { font-family: 'Times New Roman', serif; letter-spacing: 1px; }
        .sub { vertical-align: sub; font-size: 0.7em; }
        .sup { vertical-align: super; font-size: 0.7em; }
        /* Simple spinner */
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3b82f6; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* ã‚¹ã‚¿ãƒ³ãƒ—ç”¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .stamp-appear { animation: stamp-pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; opacity: 0; transform: scale(0.5) rotate(-15deg); }
        @keyframes stamp-pop { 
            0% { opacity: 0; transform: scale(0.5) rotate(-15deg); } 
            100% { opacity: 1; transform: scale(1) rotate(0deg); } 
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // Part 1: é…¸åŒ–æ•°æ±ºå®š
        const oxNumQuestions = [
            { id: "1-01", formula: "\\text{H}_2", target: "H", answer: "0", note: "å˜ä½“" },
            { id: "1-02", formula: "\\text{O}_2", target: "O", answer: "0", note: "å˜ä½“" },
            { id: "1-03", formula: "\\text{Cu}", target: "Cu", answer: "0", note: "å˜ä½“" },
            { id: "1-04", formula: "\\text{Fe}", target: "Fe", answer: "0", note: "å˜ä½“" },
            { id: "1-05", formula: "\\text{Al}", target: "Al", answer: "0", note: "å˜ä½“" },
            { id: "1-06", formula: "\\text{H}_2\\text{O}", target: "H", answer: "+1", note: "ä¸€èˆ¬" },
            { id: "1-07", formula: "\\text{H}_2\\text{O}", target: "O", answer: "-2", note: "ä¸€èˆ¬" },
            { id: "1-08", formula: "\\text{NH}_3", target: "H", answer: "+1", note: "ä¸€èˆ¬" },
            { id: "1-09", formula: "\\text{NH}_3", target: "N", answer: "-3", note: "ä¸€èˆ¬" },
            { id: "1-10", formula: "\\text{CH}_4", target: "C", answer: "-4", note: "ä¸€èˆ¬" },
            { id: "1-11", formula: "\\text{CO}_2", target: "C", answer: "+4", note: "ä¸€èˆ¬" },
            { id: "1-12", formula: "\\text{CO}_2", target: "O", answer: "-2", note: "ä¸€èˆ¬" },
            { id: "1-13", formula: "\\text{HCl}", target: "Cl", answer: "-1", note: "ä¸€èˆ¬" },
            { id: "1-14", formula: "\\text{NaCl}", target: "Na", answer: "+1", note: "ã‚¢ãƒ«ã‚«ãƒªé‡‘å±" },
            { id: "1-15", formula: "\\text{NaCl}", target: "Cl", answer: "-1", note: "ä¸€èˆ¬" },
            { id: "1-16", formula: "\\text{MgO}", target: "Mg", answer: "+2", note: "ã‚¢ãƒ«ã‚«ãƒªåœŸé¡é‡‘å±" },
            { id: "1-17", formula: "\\text{Al}_2\\text{O}_3", target: "Al", answer: "+3", note: "ä¸€èˆ¬" },
            { id: "1-18", formula: "\\text{CuCl}_2", target: "Cu", answer: "+2", note: "ä¸€èˆ¬" },
            { id: "1-19", formula: "\\text{Fe}_2\\text{O}_3", target: "Fe", answer: "+3", note: "ä¸€èˆ¬" },
            { id: "1-20", formula: "\\text{FeCl}_2", target: "Fe", answer: "+2", note: "ä¸€èˆ¬" },
            { id: "1-21", formula: "\\text{HNO}_3", target: "N", answer: "+5", note: "é…¸" },
            { id: "1-22", formula: "\\text{H}_2\\text{SO}_4", target: "S", answer: "+6", note: "é…¸" },
            { id: "1-23", formula: "\\text{H}_2\\text{S}", target: "S", answer: "-2", note: "ä¸€èˆ¬" },
            { id: "1-24", formula: "\\text{SO}_2", target: "S", answer: "+4", note: "ä¸€èˆ¬" },
            { id: "1-25", formula: "\\text{H}_2\\text{SO}_3", target: "S", answer: "+4", note: "é…¸" },
            { id: "1-26", formula: "\\text{HClO}", target: "Cl", answer: "+1", note: "æ¬¡äºœå¡©ç´ é…¸" },
            { id: "1-27", formula: "\\text{HClO}_3", target: "Cl", answer: "+5", note: "å¡©ç´ é…¸" },
            { id: "1-28", formula: "\\text{KMnO}_4", target: "Mn", answer: "+7", note: "é‡è¦é…¸åŒ–å‰¤" },
            { id: "1-29", formula: "\\text{K}_2\\text{Cr}_2\\text{O}_7", target: "Cr", answer: "+6", note: "é‡è¦é…¸åŒ–å‰¤" },
            { id: "1-30", formula: "\\text{MnO}_2", target: "Mn", answer: "+4", note: "ä¸€èˆ¬" },
            { id: "1-31", formula: "\\text{NO}_2", target: "N", answer: "+4", note: "ä¸€èˆ¬" },
            { id: "1-32", formula: "\\text{NO}", target: "N", answer: "+2", note: "ä¸€èˆ¬" },
            { id: "1-33", formula: "\\text{H}_2\\text{O}_2", target: "O", answer: "-1", note: "ä¾‹å¤– (éé…¸åŒ–ç‰©)" },
            { id: "1-34", formula: "\\text{NaH}", target: "H", answer: "-1", note: "ä¾‹å¤– (é‡‘å±æ°´ç´ åŒ–ç‰©)" },
            { id: "1-35", formula: "\\text{CaH}_2", target: "H", answer: "-1", note: "ä¾‹å¤– (é‡‘å±æ°´ç´ åŒ–ç‰©)" },
            { id: "1-36", formula: "\\text{NH}_4^+", target: "N", answer: "-3", note: "å¤šåŸå­ã‚¤ã‚ªãƒ³" },
            { id: "1-37", formula: "\\text{SO}_4^{2-}", target: "S", answer: "+6", note: "å¤šåŸå­ã‚¤ã‚ªãƒ³" },
            { id: "1-38", formula: "\\text{NO}_3^-", target: "N", answer: "+5", note: "å¤šåŸå­ã‚¤ã‚ªãƒ³" },
            { id: "1-39", formula: "\\text{MnO}_4^-", target: "Mn", answer: "+7", note: "å¤šåŸå­ã‚¤ã‚ªãƒ³" },
            { id: "1-40", formula: "\\text{Cr}_2\\text{O}_7^{2-}", target: "Cr", answer: "+6", note: "å¤šåŸå­ã‚¤ã‚ªãƒ³" },
            { id: "1-41", formula: "\\text{PO}_4^{3-}", target: "P", answer: "+5", note: "å¤šåŸå­ã‚¤ã‚ªãƒ³" },
            { id: "1-42", formula: "\\text{OH}^-", target: "O", answer: "-2", note: "å¤šåŸå­ã‚¤ã‚ªãƒ³" },
            { id: "1-43", formula: "\\text{Cu}_2\\text{O}", target: "Cu", answer: "+1", note: "ä¸€èˆ¬" },
            { id: "1-44", formula: "\\text{SnCl}_2", target: "Sn", answer: "+2", note: "ä¸€èˆ¬" },
            { id: "1-45", formula: "\\text{SnCl}_4", target: "Sn", answer: "+4", note: "ä¸€èˆ¬" },
            { id: "1-46", formula: "\\text{O}_3", target: "O", answer: "0", note: "å˜ä½“ï¼ˆã‚ªã‚¾ãƒ³ï¼‰" },
            { id: "1-47", formula: "\\text{PbO}_2", target: "Pb", answer: "+4", note: "ä¸€èˆ¬" },
            { id: "1-48", formula: "\\text{FeSO}_4", target: "Fe", answer: "+2", note: "å¡©" },
            { id: "1-49", formula: "\\text{Na}_2\\text{S}_2\\text{O}_3", target: "S", answer: "+2", note: "ãƒã‚ªç¡«é…¸ï¼ˆå¹³å‡ï¼‰" },
            { id: "1-50", formula: "\\text{C}_2\\text{H}_6\\text{O}", target: "C", answer: "-2", note: "æœ‰æ©Ÿç‰©ï¼ˆå¹³å‡ï¼‰" }
        ];

        // Part 2: é…¸åŒ–é‚„å…ƒåå¿œ
        const redoxQuestions = [
            { id: "2-01", eq: "2\\text{Cu} + \\text{O}_2 \\to 2\\text{CuO}", q: "é…¸åŒ–ã•ã‚ŒãŸç‰©è³ªã¯ï¼Ÿ", a: "Cu", exp: "Cu (0 â†’ +2)" },
            { id: "2-02", eq: "2\\text{Cu} + \\text{O}_2 \\to 2\\text{CuO}", q: "é…¸åŒ–å‰¤ã¯ï¼Ÿ", a: "O2", exp: "ç›¸æ‰‹ã‚’é…¸åŒ–ã—ãŸ" },
            { id: "2-03", eq: "\\text{CuO} + \\text{H}_2 \\to \\text{Cu} + \\text{H}_2\\text{O}", q: "é‚„å…ƒã•ã‚ŒãŸç‰©è³ªã¯ï¼Ÿ", a: "CuO", exp: "Cu (+2 â†’ 0)" },
            { id: "2-04", eq: "\\text{CuO} + \\text{H}_2 \\to \\text{Cu} + \\text{H}_2\\text{O}", q: "é‚„å…ƒå‰¤ã¯ï¼Ÿ", a: "H2", exp: "ç›¸æ‰‹ã‚’é‚„å…ƒã—ãŸ" },
            { id: "2-05", eq: "2\\text{Mg} + \\text{CO}_2 \\to 2\\text{MgO} + \\text{C}", q: "é…¸åŒ–å‰¤ã¯ï¼Ÿ", a: "CO2", exp: "CãŒ+4â†’0ã«é‚„å…ƒã•ã‚ŒãŸ" },
            { id: "2-06", eq: "2\\text{Mg} + \\text{CO}_2 \\to 2\\text{MgO} + \\text{C}", q: "é…¸åŒ–ã•ã‚ŒãŸç‰©è³ªã¯ï¼Ÿ", a: "Mg", exp: "Mg (0 â†’ +2)" },
            { id: "2-07", eq: "\\text{Fe} + \\text{S} \\to \\text{FeS}", q: "é‚„å…ƒå‰¤ã¯ï¼Ÿ", a: "Fe", exp: "é›»å­ã‚’æ”¾å‡ºã—ãŸ" },
            { id: "2-08", eq: "2\\text{Na} + \\text{Cl}_2 \\to 2\\text{NaCl}", q: "é…¸åŒ–å‰¤ã¯ï¼Ÿ", a: "Cl2", exp: "é›»å­ã‚’å—ã‘å–ã£ãŸ" },
            { id: "2-09", eq: "\\text{Zn} + 2\\text{HCl} \\to \\text{ZnCl}_2 + \\text{H}_2", q: "é…¸åŒ–ã•ã‚ŒãŸç‰©è³ªã¯ï¼Ÿ", a: "Zn", exp: "Zn (0 â†’ +2)" },
            { id: "2-10", eq: "\\text{Zn} + 2\\text{HCl} \\to \\text{ZnCl}_2 + \\text{H}_2", q: "é‚„å…ƒã•ã‚ŒãŸç‰©è³ªã¯ï¼Ÿ", a: "HCl", exp: "HãŒ+1â†’0" },
            { id: "2-11", eq: "\\text{H}_2\\text{S} + \\text{I}_2 \\to \\text{S} + 2\\text{HI}", q: "é…¸åŒ–å‰¤ã¯ï¼Ÿ", a: "I2", exp: "I (0 â†’ -1)" },
            { id: "2-12", eq: "\\text{H}_2\\text{S} + \\text{I}_2 \\to \\text{S} + 2\\text{HI}", q: "é‚„å…ƒå‰¤ã¯ï¼Ÿ", a: "H2S", exp: "S (-2 â†’ 0)" },
            { id: "2-13", eq: "\\text{SO}_2 + 2\\text{H}_2\\text{S} \\to 3\\text{S} + 2\\text{H}_2\\text{O}", q: "é…¸åŒ–å‰¤ã¯ï¼Ÿ", a: "SO2", exp: "S (+4 â†’ 0)" },
            { id: "2-14", eq: "\\text{SO}_2 + 2\\text{H}_2\\text{S} \\to 3\\text{S} + 2\\text{H}_2\\text{O}", q: "é‚„å…ƒå‰¤ã¯ï¼Ÿ", a: "H2S", exp: "S (-2 â†’ 0)" },
            { id: "2-15", eq: "\\text{SO}_2 + \\text{H}_2\\text{O}_2 \\to \\text{H}_2\\text{SO}_4", q: "é‚„å…ƒå‰¤ã¯ï¼Ÿ", a: "SO2", exp: "S (+4 â†’ +6)" },
            { id: "2-16", eq: "\\text{SO}_2 + \\text{H}_2\\text{O}_2 \\to \\text{H}_2\\text{SO}_4", q: "é…¸åŒ–å‰¤ã¯ï¼Ÿ", a: "H2O2", exp: "O (-1 â†’ -2)" },
            { id: "2-17", eq: "2\\text{KI} + \\text{Cl}_2 \\to 2\\text{KCl} + \\text{I}_2", q: "é…¸åŒ–å‰¤ã¯ï¼Ÿ", a: "Cl2", exp: "ãƒãƒ­ã‚²ãƒ³ã®é…¸åŒ–åŠ›" },
            { id: "2-18", eq: "2\\text{FeCl}_2 + \\text{Cl}_2 \\to 2\\text{FeCl}_3", q: "é…¸åŒ–ã•ã‚ŒãŸç‰©è³ªã¯ï¼Ÿ", a: "FeCl2", exp: "Fe (+2 â†’ +3)" },
            { id: "2-19", eq: "\\text{MnO}_2 + 4\\text{HCl} \\to \\text{MnCl}_2 + 2\\text{H}_2\\text{O} + \\text{Cl}_2", q: "é…¸åŒ–å‰¤ã¯ï¼Ÿ", a: "MnO2", exp: "Mn (+4 â†’ +2)" },
            { id: "2-20", eq: "\\text{MnO}_2 + 4\\text{HCl} \\to \\text{MnCl}_2 + 2\\text{H}_2\\text{O} + \\text{Cl}_2", q: "é‚„å…ƒå‰¤ã¯ï¼Ÿ", a: "HCl", exp: "Cl (-1 â†’ 0)" },
            { id: "2-21", eq: "\\text{Cu} + 4\\text{HNO}_3 \\to \\text{Cu}(\\text{NO}_3)_2 + 2\\text{NO}_2 + 2\\text{H}_2\\text{O}", q: "é…¸åŒ–å‰¤ã¯ï¼Ÿ", a: "HNO3", exp: "N (+5 â†’ +4)" },
            { id: "2-22", eq: "\\text{SnCl}_2 + 2\\text{FeCl}_3 \\to \\text{SnCl}_4 + 2\\text{FeCl}_2", q: "é‚„å…ƒå‰¤ã¯ï¼Ÿ", a: "SnCl2", exp: "Sn (+2 â†’ +4)" },
            { id: "2-23", eq: "\\text{SnCl}_2 + 2\\text{FeCl}_3 \\to \\text{SnCl}_4 + 2\\text{FeCl}_2", q: "é…¸åŒ–å‰¤ã¯ï¼Ÿ", a: "FeCl3", exp: "Fe (+3 â†’ +2)" },
            { id: "2-24", eq: "2\\text{Na} + 2\\text{H}_2\\text{O} \\to 2\\text{NaOH} + \\text{H}_2", q: "é…¸åŒ–ã•ã‚ŒãŸç‰©è³ªã¯ï¼Ÿ", a: "Na", exp: "Na (0 â†’ +1)" },
            { id: "2-25", eq: "2\\text{Na} + 2\\text{H}_2\\text{O} \\to 2\\text{NaOH} + \\text{H}_2", q: "é…¸åŒ–å‰¤ã¯ï¼Ÿ", a: "H2O", exp: "æ°´ã®HãŒé‚„å…ƒã•ã‚ŒãŸ" },
            { id: "2-26", eq: "2\\text{Al} + \\text{Fe}_2\\text{O}_3 \\to \\text{Al}_2\\text{O}_3 + 2\\text{Fe}", q: "é‚„å…ƒå‰¤ã¯ï¼Ÿ", a: "Al", exp: "ãƒ†ãƒ«ãƒŸãƒƒãƒˆåå¿œ" },
            { id: "2-27", eq: "\\text{CH}_4 + 2\\text{O}_2 \\to \\text{CO}_2 + 2\\text{H}_2\\text{O}", q: "é‚„å…ƒã•ã‚ŒãŸç‰©è³ªã¯ï¼Ÿ", a: "O2", exp: "ç‡ƒç„¼ã¯é…¸åŒ–åå¿œ" },
            { id: "2-28", eq: "5\\text{H}_2\\text{O}_2 + 2\\text{KMnO}_4 + 3\\text{H}_2\\text{SO}_4 \\dots", q: "é‚„å…ƒå‰¤ã¯ï¼Ÿ", a: "H2O2", exp: "KMnO4ç›¸æ‰‹ãªã‚‰é‚„å…ƒå‰¤" },
            { id: "2-29", eq: "\\text{H}_2\\text{O}_2 + 2\\text{KI} + \\text{H}_2\\text{SO}_4 \\dots", q: "é…¸åŒ–å‰¤ã¯ï¼Ÿ", a: "H2O2", exp: "KIç›¸æ‰‹ãªã‚‰é…¸åŒ–å‰¤" },
            { id: "2-30", eq: "\\text{Cl}_2 + \\text{H}_2\\text{O} \\rightleftharpoons \\text{HCl} + \\text{HClO}", q: "é…¸åŒ–å‰¤ã‹ã¤é‚„å…ƒå‰¤ï¼Ÿ", a: "Cl2", exp: "è‡ªå·±é…¸åŒ–é‚„å…ƒåå¿œ" }
        ];

        // ==========================================
        // COMPONENTS
        // ==========================================

        const Formula = ({ text, highlight }) => {
            if (!text) return null;
            let html = text.replace(/\\text\{([^}]+)\}/g, '$1');
            html = html.replace(/_(\{[^}]+\}|\d+)/g, (match, p1) => {
                const content = p1.replace(/\{|\}/g, '');
                return `<sub>${content}</sub>`;
            });
            html = html.replace(/\^(\{[^}]+\}|\d+|\S)/g, (match, p1) => { 
                const content = p1.replace(/\{|\}/g, '');
                return `<sup>${content}</sup>`;
            });
            html = html.replace(/\\to/g, 'â†’').replace(/\\rightleftharpoons/g, 'â‡„').replace(/\\dots/g, 'â€¦');

            // ãƒã‚¤ãƒ©ã‚¤ãƒˆå‡¦ç†: å¯¾è±¡åŸå­ï¼ˆä¾‹ï¼šH, Cuï¼‰ã‚’èµ¤è‰²å¤ªå­—ï¼‹ä¸‹ç·šã§å¼·èª¿
            // æ³¨æ„: å˜ç´”ãªç½®æ›ã ã¨ä¸€éƒ¨ã®æ–‡å­—åˆ—ã«å«ã¾ã‚Œã‚‹æ–‡å­—ã‚‚ç½®æ›ã™ã‚‹ãƒªã‚¹ã‚¯ãŒã‚ã‚‹ãŒã€
            // ä»Šå›ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆï¼ˆå…ƒç´ è¨˜å·ï¼‰ã§ã‚ã‚Œã°æ¦‚ã­å®‰å…¨ã€‚
            if (highlight) {
                // ã‚¿ã‚°ï¼ˆ<sub>ç­‰ï¼‰ã‚’å£Šã•ãªã„ã‚ˆã†ã«ã€HTMLã‚¿ã‚°ä»¥å¤–ã®éƒ¨åˆ†ã§ãƒãƒƒãƒã•ã›ã‚‹ç°¡æ˜“çš„ãªæ‰‹æ³•
                // ã“ã“ã§ã¯å˜ç´”åŒ–ã®ãŸã‚ã€ç”Ÿæˆå¾Œã®HTMLæ–‡å­—åˆ—ã«å¯¾ã—ã¦ç½®æ›ã‚’è¡Œã†ã€‚
                const regex = new RegExp(`(${highlight})`, 'g');
                // <sub>ã‚„<sup>ã®ä¸­èº«ã‚‚å…ƒç´ è¨˜å·ãªã‚‰ãƒã‚¤ãƒ©ã‚¤ãƒˆã•ã‚Œã¦ã‚‚OK
                html = html.replace(regex, `<span class="text-red-600 font-bold border-b-2 border-red-600">$1</span>`);
            }

            return <span className="chemical-formula" dangerouslySetInnerHTML={{ __html: html }} />;
        };

        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-xl shadow-md p-6 ${className}`}>{children}</div>
        );

        const Button = ({ onClick, children, variant = "primary", className = "", disabled=false }) => {
            const base = "px-4 py-2 rounded-lg font-bold transition duration-200 transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed";
            const styles = {
                primary: "bg-blue-600 text-white hover:bg-blue-700",
                secondary: "bg-gray-200 text-gray-800 hover:bg-gray-300",
                danger: "bg-red-500 text-white hover:bg-red-600",
                success: "bg-green-500 text-white hover:bg-green-600",
                outline: "border-2 border-blue-600 text-blue-600 hover:bg-blue-50"
            };
            return (
                <button onClick={onClick} className={`${base} ${styles[variant]} ${className}`} disabled={disabled}>
                    {children}
                </button>
            );
        };

        // ==========================================
        // MAIN APP LOGIC
        // ==========================================
        
        const ADMIN_EMAILS = []; 

        function App() {
            const [user, setUser] = useState(null);
            const [userData, setUserData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState("login");
            const [errorMsg, setErrorMsg] = useState("");

            useEffect(() => {
                if (!window.auth || !window.onAuthStateChanged) {
                    setErrorMsg("Firebase Initialization Error");
                    setLoading(false);
                    return;
                }

                const unsubscribe = window.onAuthStateChanged(window.auth, async (currentUser) => {
                    setUser(currentUser);
                    if (currentUser) {
                        await checkUserRegistration(currentUser);
                    } else {
                        setUserData(null);
                        setLoading(false);
                    }
                });
                return () => unsubscribe();
            }, []);

            const checkUserRegistration = async (authUser) => {
                setLoading(true);
                setErrorMsg("");
                try {
                    const email = authUser.email;
                    const docRef = window.doc(window.db, "users", email);
                    const docSnap = await window.getDoc(docRef);

                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (!data.uid) {
                            await window.updateDoc(docRef, {
                                uid: authUser.uid,
                                lastLogin: window.serverTimestamp(),
                                photoURL: authUser.photoURL
                            });
                        }
                        setUserData(data);
                        setView(data.role === 'admin' ? 'admin' : 'dashboard');
                    } else {
                        if (ADMIN_EMAILS.includes(email)) {
                             const newAdmin = {
                                email: email,
                                name: authUser.displayName,
                                role: 'admin',
                                registeredAt: window.serverTimestamp()
                            };
                            await window.setDoc(docRef, newAdmin);
                            setUserData(newAdmin);
                            setView('admin');
                        } else {
                            setErrorMsg("ã‚ãªãŸã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚æ‹…å½“æ•™å“¡ã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚");
                            await window.signOut(window.auth);
                        }
                    }
                } catch (err) {
                    console.error("Auth Error:", err);
                    setErrorMsg("ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
                }
                setLoading(false);
            };

            const handleLogin = async () => {
                try {
                    await window.signInWithPopup(window.auth, window.provider);
                } catch (err) {
                    console.error("Login Failed:", err);
                    if (err.code === 'auth/unauthorized-domain') {
                        setErrorMsg(`ãƒ‰ãƒ¡ã‚¤ãƒ³è¨±å¯ã‚¨ãƒ©ãƒ¼: Firebase Consoleã®Authenticationè¨­å®šã§ã€ã“ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ (${window.location.hostname}) ã‚’ã€Œæ‰¿èªæ¸ˆã¿ãƒ‰ãƒ¡ã‚¤ãƒ³ã€ã«è¿½åŠ ã—ã¦ãã ã•ã„ã€‚`);
                    } else if (err.code === 'auth/popup-closed-by-user') {
                        setErrorMsg("ãƒ­ã‚°ã‚¤ãƒ³ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚");
                    } else {
                        setErrorMsg("ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message);
                    }
                }
            };

            const handleLogout = async () => {
                await window.signOut(window.auth);
                setView("login");
            };

            if (loading) return <div className="min-h-screen flex items-center justify-center"><div className="loader"></div></div>;

            return (
                <div className="min-h-screen pb-10">
                    <header className="bg-gradient-to-r from-blue-700 to-indigo-800 text-white p-4 shadow-lg">
                        <div className="max-w-4xl mx-auto flex justify-between items-center">
                            <h1 className="text-xl font-bold flex items-center gap-2">
                                <span className="text-2xl">âš—ï¸</span> é…¸åŒ–é‚„å…ƒãƒã‚¹ã‚¿ãƒ¼
                            </h1>
                            {userData && (
                                <div className="flex items-center gap-4">
                                    <div className="text-sm text-right hidden sm:block">
                                        <p className="font-bold">{userData.name}</p>
                                        <p className="opacity-80 text-xs">{userData.grade}å¹´{userData.class}çµ„ {userData.role === 'admin' ? 'â˜…ç®¡ç†è€…' : ''}</p>
                                    </div>
                                    <button onClick={handleLogout} className="text-xs bg-white/20 hover:bg-white/30 px-3 py-1 rounded">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                                </div>
                            )}
                        </div>
                    </header>

                    <main className="max-w-4xl mx-auto mt-6 px-4">
                        {errorMsg && (
                            <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6" role="alert">
                                <p>{errorMsg}</p>
                            </div>
                        )}

                        {!userData ? (
                            <div className="flex flex-col items-center justify-center py-20">
                                <Card className="text-center max-w-md w-full">
                                    <h2 className="text-2xl font-bold mb-4 text-gray-800">å­¦ç¿’ã‚’å§‹ã‚ã‚‹</h2>
                                    <p className="text-gray-600 mb-8">å­¦æ ¡ã®Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚</p>
                                    <Button onClick={handleLogin} className="w-full py-3 flex justify-center items-center gap-2">
                                        <svg className="w-5 h-5" viewBox="0 0 24 24"><path fill="currentColor" d="M12.545,10.239v3.821h5.445c-0.712,2.315-2.647,3.972-5.445,3.972c-3.332,0-6.033-2.536-6.033-5.667s2.7-5.667,6.033-5.667c1.398,0,2.684,0.491,3.673,1.303l2.966-2.966C17.37,3.468,15.113,2.441,12.545,2.441C7.156,2.441,2.787,6.81,2.787,12.2s4.369,9.759,9.759,9.759c5.631,0,9.363-3.956,9.363-9.524c0-0.654-0.061-1.298-0.166-1.921L12.545,10.239z"/></svg>
                                        Googleã§ãƒ­ã‚°ã‚¤ãƒ³
                                    </Button>
                                </Card>
                            </div>
                        ) : (
                            <>
                                {view === 'dashboard' && <Dashboard user={userData} setView={setView} />}
                                {view === 'quiz1' && <QuizGame questions={oxNumQuestions} type="part1" user={userData} onBack={() => setView('dashboard')} />}
                                {view === 'quiz2' && <QuizGame questions={redoxQuestions} type="part2" user={userData} onBack={() => setView('dashboard')} />}
                                {view === 'admin' && <AdminPanel user={userData} setView={setView} />}
                            </>
                        )}
                    </main>
                </div>
            );
        }

        function Dashboard({ user, setView }) {
            const StampCardArea = ({ plays = 0, colorClass = "text-red-500" }) => {
                const maxStamps = 10;
                const displayCount = Math.min(plays, maxStamps);
                
                return (
                    <div className="mt-4 bg-orange-50/50 border border-orange-100 rounded-lg p-3">
                        <div className="flex justify-between items-center mb-2">
                            <span className="text-xs font-bold text-gray-500">ã‚¹ã‚¿ãƒ³ãƒ—å¸³</span>
                            <span className="text-xs font-bold bg-orange-100 text-orange-800 px-2 py-0.5 rounded-full">
                                ã‚¯ãƒªã‚¢å›æ•°: {plays}å›
                            </span>
                        </div>
                        <div className="flex flex-wrap gap-1 min-h-[40px] items-center">
                            {plays === 0 && (
                                <span className="text-xs text-gray-400 w-full text-center py-1">
                                    ã‚¯ãƒªã‚¢ã—ã¦ã‚¹ã‚¿ãƒ³ãƒ—ã‚’é›†ã‚ã‚ˆã†ï¼
                                </span>
                            )}
                            {[...Array(displayCount)].map((_, i) => (
                                <div key={i} 
                                     className="stamp-appear text-2xl select-none filter drop-shadow-sm transform hover:scale-125 transition-transform cursor-default"
                                     style={{ animationDelay: `${i * 0.05}s` }}
                                     title={`${i + 1}å›ç›®ã®ã‚¯ãƒªã‚¢ï¼`}>
                                    ğŸ’®
                                </div>
                            ))}
                            {plays > maxStamps && (
                                <div className="ml-1 flex items-center justify-center w-8 h-8 bg-orange-200 text-orange-800 rounded-full text-xs font-bold shadow-sm stamp-appear" style={{ animationDelay: '0.5s' }}>
                                    +{plays - maxStamps}
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            return (
                <div className="space-y-6">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <Card className="hover:shadow-xl transition-shadow border-t-4 border-blue-500 cursor-pointer flex flex-col justify-between" >
                            <div>
                                <div className="flex justify-between items-start mb-4">
                                    <h3 className="text-xl font-bold text-gray-800">Part 1: é…¸åŒ–æ•°æ±ºå®š</h3>
                                    <span className="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">å…¨10å• (90ç§’)</span>
                                </div>
                                <p className="text-gray-600 text-sm mb-4">å˜ä½“ã€åŒ–åˆç‰©ã€ã‚¤ã‚ªãƒ³ã€ãã—ã¦ä¾‹å¤–çš„ãªç‰©è³ªã®é…¸åŒ–æ•°ã‚’ç´ æ—©ãè¦‹æŠœã“ã†ï¼<br/><span className="text-red-500 font-bold">8å•ä»¥ä¸Šæ­£è§£ã§ã‚¯ãƒªã‚¢ï¼</span></p>
                                <StampCardArea plays={user.progress?.part1?.plays || 0} />
                            </div>
                            <div className="flex justify-between items-center mt-6 pt-4 border-t border-gray-100">
                                <div className="text-sm text-gray-500">
                                    æœ€é«˜ã‚¹ã‚³ã‚¢: <span className="font-bold text-blue-600">{user.progress?.part1?.highScore || 0}</span>
                                </div>
                                <Button onClick={() => setView('quiz1')}>ã‚¹ã‚¿ãƒ¼ãƒˆ</Button>
                            </div>
                        </Card>

                        <Card className="hover:shadow-xl transition-shadow border-t-4 border-green-500 cursor-pointer flex flex-col justify-between">
                            <div>
                                <div className="flex justify-between items-start mb-4">
                                    <h3 className="text-xl font-bold text-gray-800">Part 2: é…¸åŒ–é‚„å…ƒåå¿œ</h3>
                                    <span className="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">å…¨10å• (90ç§’)</span>
                                </div>
                                <p className="text-gray-600 text-sm mb-4">é…¸åŒ–å‰¤ãƒ»é‚„å…ƒå‰¤ã‚’è¦‹æ¥µã‚ã‚ã€‚ã€Œé…¸åŒ–ã•ã‚ŒãŸç‰©è³ªã€ã¨ã®é•ã„ã«æ³¨æ„ï¼<br/><span className="text-green-600 font-bold">8å•ä»¥ä¸Šæ­£è§£ã§ã‚¯ãƒªã‚¢ï¼</span></p>
                                <StampCardArea plays={user.progress?.part2?.plays || 0} />
                            </div>
                            <div className="flex justify-between items-center mt-6 pt-4 border-t border-gray-100">
                                <div className="text-sm text-gray-500">
                                    æœ€é«˜ã‚¹ã‚³ã‚¢: <span className="font-bold text-green-600">{user.progress?.part2?.highScore || 0}</span>
                                </div>
                                <Button onClick={() => setView('quiz2')} variant="success">ã‚¹ã‚¿ãƒ¼ãƒˆ</Button>
                            </div>
                        </Card>
                    </div>

                    {user.role === 'admin' && (
                        <div className="text-center mt-8">
                            <Button onClick={() => setView('admin')} variant="secondary">ç®¡ç†è€…ãƒ‘ãƒãƒ«ã¸ç§»å‹•</Button>
                        </div>
                    )}
                </div>
            );
        }

        // ==========================================
        // QUIZ INPUT COMPONENT (Fixes Minified Error #310)
        // ==========================================
        const QuizInput = ({ type, currentQ, submitAnswer }) => {
            const options = useMemo(() => {
                if (type === 'part1') return [];
                if (!currentQ) return [];
                
                // Extract chemicals from equation
                const parts = currentQ.eq.split(/\\to|\+|\s+/).filter(p => p.includes('\\text') && p.length > 5).map(p => p.replace(/^[0-9]+/, ''));
                // Clean parts
                const cleanParts = [...new Set(parts.map(p => p.replace(/\\text\{([^}]+)\}.*/, '$1').replace(/_/g, '').replace(/[^a-zA-Z0-9]/g, '')))];
                const correct = currentQ.a;
                let pool = [...cleanParts];
                if (!pool.includes(correct)) pool.push(correct);
                if (pool.length < 3) pool.push("H2O", "e-", "H+");
                
                return pool.slice(0, 4).sort();
            }, [currentQ, type]);

            if (type === 'part1') {
                const buttons = ["+1", "+2", "+3", "+4", "+5", "+6", "+7", "0", "-1", "-2", "-3", "-4"];
                return (
                    <div className="grid grid-cols-4 gap-2 mt-4">
                        {buttons.map(b => (
                            <button key={b} onClick={() => submitAnswer(b)} 
                                className="bg-blue-50 hover:bg-blue-100 text-blue-800 font-bold py-3 rounded border border-blue-200 shadow-sm">
                                {b}
                            </button>
                        ))}
                    </div>
                );
            } else {
                return (
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-4">
                        {options.map((opt, i) => (
                            <button key={i} onClick={() => submitAnswer(opt)}
                                className="bg-indigo-50 hover:bg-indigo-100 text-indigo-900 font-bold py-3 rounded border border-indigo-200">
                                <Formula text={`\\text{${opt}}`} />
                            </button>
                        ))}
                    </div>
                );
            }
        };

        function QuizGame({ questions, type, user, onBack }) {
            const [currentQIndex, setCurrentQIndex] = useState(0);
            const [shuffledQuestions, setShuffledQuestions] = useState([]);
            const [score, setScore] = useState(0);
            const [correctCount, setCorrectCount] = useState(0); // æ­£è§£æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            const [gameState, setGameState] = useState('ready');
            const [feedback, setFeedback] = useState(null);
            const [timeLeft, setTimeLeft] = useState(90); // 90ç§’ã‚¿ã‚¤ãƒãƒ¼

            useEffect(() => {
                // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦10å•ã ã‘é¸ã¶
                const shuffled = [...questions].sort(() => 0.5 - Math.random()).slice(0, 10);
                setShuffledQuestions(shuffled);
                setGameState('playing');
                setTimeLeft(90);
            }, [questions]);

            // ã‚¿ã‚¤ãƒãƒ¼å‡¦ç†
            useEffect(() => {
                if (gameState !== 'playing') return;
                
                const timer = setInterval(() => {
                    setTimeLeft(prev => {
                        if (prev <= 1) {
                            clearInterval(timer);
                            // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚ã®å‡¦ç†ï¼ˆã‚²ãƒ¼ãƒ çµ‚äº†ã¸ï¼‰
                            setGameState('timeout');
                            return 0;
                        }
                        return prev - 1;
                    });
                }, 1000);

                return () => clearInterval(timer);
            }, [gameState]);

            // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç›£è¦–
            useEffect(() => {
                if (gameState === 'timeout') {
                    finishGame();
                }
            }, [gameState]);

            const currentQ = shuffledQuestions[currentQIndex];

            const submitAnswer = (ans) => {
                if (gameState === 'feedback') return;
                
                const isCorrect = normalize(ans) === normalize(currentQ.answer || currentQ.a);
                const explanation = type === 'part1' ? 
                    `${currentQ.target}ã®é…¸åŒ–æ•°ã¯ ${currentQ.answer} (${currentQ.note})` : 
                    `${currentQ.a}ã€‚è§£èª¬: ${currentQ.exp}`;

                setFeedback({
                    correct: isCorrect,
                    msg: explanation,
                    correctAnswer: type === 'part1' ? currentQ.answer : currentQ.a
                });
                
                if (isCorrect) {
                    setScore(s => s + 10); // å¾—ç‚¹è¨ˆç®—ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ã«1å•10ç‚¹ï¼‰
                    setCorrectCount(c => c + 1);
                }

                setGameState('feedback');
            };

            const nextQuestion = () => {
                setFeedback(null);
                if (currentQIndex + 1 >= shuffledQuestions.length) {
                    finishGame();
                } else {
                    setCurrentQIndex(prev => prev + 1);
                    setGameState('playing');
                }
            };

            const finishGame = async () => {
                setGameState('result');
                const isPassed = correctCount >= 8; // 8å•ä»¥ä¸Šã§åˆæ ¼

                try {
                    const docRef = window.doc(window.db, "users", user.email);
                    const currentHighScore = user.progress?.[type]?.highScore || 0;
                    const plays = user.progress?.[type]?.plays || 0;
                    
                    const updateData = {
                        [`progress.${type}.lastScore`]: score,
                        [`progress.${type}.lastPlayedAt`]: window.serverTimestamp()
                    };

                    // åˆæ ¼ï¼ˆ8å•ä»¥ä¸Šæ­£è§£ï¼‰ã®å ´åˆã®ã¿ã€ã‚¯ãƒªã‚¢å›æ•°ï¼ˆã‚¹ã‚¿ãƒ³ãƒ—ï¼‰ã‚’å¢—ã‚„ã™
                    if (isPassed) {
                         updateData[`progress.${type}.plays`] = plays + 1;
                    }

                    if (score > currentHighScore) {
                        updateData[`progress.${type}.highScore`] = score;
                    }

                    await window.updateDoc(docRef, updateData);
                } catch (err) {
                    console.error("Save score failed", err);
                }
            };

            const normalize = (str) => String(str).replace(/\s/g, '').replace(/ï¼‹/g, '+').replace(/âˆ’/g, '-');

            if (gameState === 'result' || gameState === 'timeout') {
                const isPassed = correctCount >= 8;
                return (
                    <Card className="text-center py-10">
                        <h2 className="text-3xl font-bold mb-4">çµæœç™ºè¡¨</h2>
                        {gameState === 'timeout' && <div className="text-red-500 font-bold mb-4">æ™‚é–“åˆ‡ã‚Œï¼</div>}
                        <div className="text-5xl font-black text-blue-600 mb-2">{score} <span className="text-xl text-gray-500">ç‚¹</span></div>
                        <p className="text-lg mb-2">{correctCount}å• æ­£è§£ / 10å•ä¸­</p>
                        
                        <div className={`text-2xl font-bold mb-8 py-2 px-6 rounded-full inline-block ${isPassed ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                            {isPassed ? "ğŸ’® åˆæ ¼ï¼" : "ğŸ’ª ã‚ã¨ä¸€æ­©..."}
                        </div>
                        <br/>
                        <Button onClick={onBack}>ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</Button>
                    </Card>
                );
            }

            if (!currentQ) return <div className="loader mx-auto"></div>;

            return (
                <div className="max-w-2xl mx-auto">
                    <div className="flex justify-between items-center mb-2 text-sm font-bold text-gray-600">
                        <div>Q. {currentQIndex + 1} / 10</div>
                        <div className={`text-lg ${timeLeft < 10 ? 'text-red-600 animate-pulse' : 'text-blue-600'}`}>
                            â±ï¸ {timeLeft}ç§’
                        </div>
                        <div>Score: {score}</div>
                    </div>
                    
                    <div className="w-full bg-gray-200 rounded-full h-2 mb-6">
                        <div className="bg-blue-600 h-2 rounded-full transition-all duration-300" style={{ width: `${((currentQIndex) / 10) * 100}%` }}></div>
                    </div>

                    <Card className="mb-6 min-h-[200px] flex flex-col justify-center items-center text-center">
                        <div className="text-lg text-gray-500 mb-2">
                            {type === 'part1' ? `å¯¾è±¡å…ƒç´ : ${currentQ.target}` : currentQ.q}
                        </div>
                        <div className="text-3xl mb-6">
                            {/* Part1ã®å ´åˆã€å¯¾è±¡å…ƒç´ ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ */}
                            <Formula 
                                text={type === 'part1' ? currentQ.formula : currentQ.eq} 
                                highlight={type === 'part1' ? currentQ.target : null} 
                            />
                        </div>
                        {type === 'part1' && <div className="text-sm text-gray-400">ã“ã®åŸå­ã®é…¸åŒ–æ•°ã¯ï¼Ÿ</div>}
                    </Card>

                    {!feedback ? (
                        <QuizInput type={type} currentQ={currentQ} submitAnswer={submitAnswer} />
                    ) : (
                        <div className={`p-4 rounded-lg border-2 text-center ${feedback.correct ? 'bg-green-50 border-green-200 text-green-800' : 'bg-red-50 border-red-200 text-red-800'}`}>
                            <div className="text-xl font-bold mb-2">
                                {feedback.correct ? "â­• æ­£è§£ï¼" : "âŒ æ®‹å¿µ..."}
                            </div>
                            <div className="mb-4">
                                {!feedback.correct && <div className="mb-1">æ­£è§£: <b>{feedback.correctAnswer}</b></div>}
                                <div className="text-sm opacity-90">{feedback.msg}</div>
                            </div>
                            <Button onClick={nextQuestion} className="w-full" variant={feedback.correct ? 'success' : 'danger'}>æ¬¡ã¸</Button>
                        </div>
                    )}
                </div>
            );
        }

        function AdminPanel({ user, setView }) {
            const [csvText, setCsvText] = useState("");
            const [students, setStudents] = useState([]);
            const [status, setStatus] = useState("");

            useEffect(() => {
                fetchStudents();
            }, []);

            const fetchStudents = async () => {
                const q = window.query(window.collection(window.db, "users"), window.where("role", "==", "student"));
                const snapshot = await window.getDocs(q);
                const list = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setStudents(list);
            };

            const handleCsvUpload = async () => {
                setStatus("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...");
                const lines = csvText.trim().split("\n");
                let count = 0;
                
                for (let line of lines) {
                    const [email, name, grade, cls, num] = line.split(",").map(s => s.trim());
                    if (!email || !email.includes("@")) continue;

                    try {
                        const docRef = window.doc(window.db, "users", email);
                        const snap = await window.getDoc(docRef);
                        if (!snap.exists()) {
                            await window.setDoc(docRef, {
                                email, name, grade, class: cls, number: num, role: 'student', createdAt: window.serverTimestamp()
                            });
                        } else {
                            await window.updateDoc(docRef, { name, grade, class: cls, number: num });
                        }
                        count++;
                    } catch (e) {
                        console.error("Error adding " + email, e);
                    }
                }
                setStatus(`${count}ä»¶ã®ç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚`);
                fetchStudents();
                setCsvText("");
            };

            const exportCsv = () => {
                let csv = "\uFEFFEmail,æ°å,å­¦å¹´,çµ„,ç•ªå·,Part1æœ€é«˜ç‚¹,Part1ã‚¯ãƒªã‚¢å›æ•°,Part2æœ€é«˜ç‚¹,Part2ã‚¯ãƒªã‚¢å›æ•°\n";
                students.forEach(s => {
                    const p1 = s.progress?.part1 || {};
                    const p2 = s.progress?.part2 || {};
                    csv += `"${s.id}","${s.name}","${s.grade}","${s.class}","${s.number}",${p1.highScore||0},${p1.plays||0},${p2.highScore||0},${p2.plays||0}\n`;
                });
                
                const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = "student_progress.csv";
                link.click();
            };

            return (
                <div className="space-y-8">
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold text-gray-800">ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
                        <Button onClick={() => setView('dashboard')} variant="outline">å­¦ç”Ÿç”»é¢ã¸</Button>
                    </div>

                    <Card>
                        <h3 className="font-bold mb-4 text-lg">ğŸ“ ç”Ÿå¾’ä¸€æ‹¬ç™»éŒ² (CSV)</h3>
                        <p className="text-sm text-gray-500 mb-2">
                            ãƒ˜ãƒƒãƒ€ãƒ¼ãªã—ã€ä»¥ä¸‹ã®é †åºã§ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š:<br/>
                            <code>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹,æ°å,å­¦å¹´,çµ„,ç•ªå·</code>
                        </p>
                        <textarea 
                            className="w-full border p-2 rounded mb-4 text-sm font-mono h-32"
                            placeholder={`student1@school.ed.jp,å±±ç”°å¤ªéƒ,1,A,1\nstudent2@school.ed.jp,éˆ´æœ¨èŠ±å­,1,A,2`}
                            value={csvText}
                            onChange={(e) => setCsvText(e.target.value)}
                        />
                        <div className="flex items-center gap-4">
                            <Button onClick={handleCsvUpload} disabled={!csvText}>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ»æ›´æ–°</Button>
                            {status && <span className="text-green-600 font-bold text-sm">{status}</span>}
                        </div>
                    </Card>

                    <Card>
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="font-bold text-lg">ğŸ“Š å­¦ç¿’çŠ¶æ³ä¸€è¦§ ({students.length}å)</h3>
                            <Button onClick={exportCsv} variant="success">CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</Button>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="min-w-full text-sm text-left text-gray-500">
                                <thead className="text-xs text-gray-700 uppercase bg-gray-50">
                                    <tr>
                                        <th className="px-4 py-3">æ°å</th>
                                        <th className="px-4 py-3">ã‚¯ãƒ©ã‚¹</th>
                                        <th className="px-4 py-3">Part 1 (ç‚¹/å›)</th>
                                        <th className="px-4 py-3">Part 2 (ç‚¹/å›)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {students.map(s => (
                                        <tr key={s.id} className="bg-white border-b hover:bg-gray-50">
                                            <td className="px-4 py-3 font-medium text-gray-900">{s.name}</td>
                                            <td className="px-4 py-3">{s.grade}-{s.class}-{s.number}</td>
                                            <td className="px-4 py-3">
                                                <span className="font-bold text-blue-600">{s.progress?.part1?.highScore || 0}</span>
                                                <span className="text-xs ml-1 text-gray-400">({s.progress?.part1?.plays || 0}å›)</span>
                                            </td>
                                            <td className="px-4 py-3">
                                                <span className="font-bold text-green-600">{s.progress?.part2?.highScore || 0}</span>
                                                <span className="text-xs ml-1 text-gray-400">({s.progress?.part2?.plays || 0}å›)</span>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </Card>
                </div>
            );
        }

        const mount = () => {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);
        };

        // Wait for Firebase module to initialize
        if (window.firebaseInitialized) {
            mount();
        } else {
            window.addEventListener('firebase-ready', mount);
        }
    </script>
</body>
</html>
